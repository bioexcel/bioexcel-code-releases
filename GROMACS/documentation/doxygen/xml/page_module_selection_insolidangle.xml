<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.5">
  <compounddef id="page_module_selection_insolidangle" kind="page">
    <compoundname>page_module_selection_insolidangle</compoundname>
    <title>Selection method: insolidangle</title>
    <detaileddescription>
<internal><para>This method selects a subset of particles that are located in a solid angle defined by a center and a set of points. The solid angle is constructed as a union of small cones whose axis goes through the center and a point. So there&apos;s such a cone for each position, and a point is in the solid angle if it lies within any of these cones. The width of the cones can be adjusted.</para><para>The method is implemented by partitioning the surface of the unit sphere into bins using the polar coordinates <formula id="12">$(\theta, \phi)$</formula>. The partitioning is always uniform in the zenith angle <formula id="13">$\theta$</formula>, while the partitioning in the azimuthal angle <formula id="7">$\phi$</formula> varies. For each reference point, the unit vector from the center to the point is constructed, and it is stored in all the bins that overlap with the cone defined by the point. Bins that are completely covered by a single cone are marked as such. Checking whether a point is in the solid angle is then straightforward with this data structure: one finds the bin that corresponds to the point, and checks whether the bin is completely covered. If it is not, one additionally needs to check whether it is within the specified cutoff of any of the stored points.</para><para>The above construction gives quite a lot of flexibility for constructing the bins without modifying the rest of the code. The current (quite inefficient) implementation is discussed below, but it should be optimized to get the most out of the code.</para><para>The current way of constructing the bins constructs the boundaries statically: the bin size in the zenith direction is set to approximately half the angle cutoff, and the bins in the azimuthal direction have sizes such that the shortest edge of the bin is approximately equal to half the angle cutoff (for the regions close to the poles, a single bin is used). Each reference point is then added to the bins as follows:<orderedlist>
<listitem><para>Find the zenith angle range that is spanned by the cone centered at the point (this is simple addition/subtraction).</para></listitem><listitem><para>Calculate the maximal span of the cone in the azimuthal direction using the formula <formula id="14">\[\sin \Delta \phi_{max} = \frac{\sin \alpha}{\sin \theta}\]</formula> (a sine formula in spherical coordinates), where <formula id="15">$\alpha$</formula> is the width of the cone and <formula id="13">$\theta$</formula> is the zenith angle of the cone center. Similarly, the zenith angle at which this extent is achieved is calculated using <formula id="16">\[\cos \theta_{max} = \frac{\cos \theta}{\cos \alpha}\]</formula> (Pythagoras&apos;s theorem in spherical coordinates).</para></listitem><listitem><para>For each zenith angle bin that is at least partially covered by the cone, calculate the span of the cone at the edges using <formula id="17">\[\sin^2 \frac{\Delta \phi}{2} = \frac{\sin^2 \frac{\alpha}{2} - \sin^2 \frac{\theta - \theta&apos;}{2}}{\sin \theta \sin \theta&apos;}\]</formula> (distance in spherical geometry), where <formula id="18">$\theta&apos;$</formula> is the zenith angle of the bin edge. Treat zenith angle bins that are completely covered by the cone (in the case that the cone is centered close to the pole) as a special case.</para></listitem><listitem><para>Using the values calculated above, loop through the azimuthal bins that are partially or completely covered by the cone and update them.</para></listitem></orderedlist>
</para><para>The total solid angle (for covered fraction calculations) is estimated by taking the total area of completely covered bins plus half the area of partially covered bins. The second one is an approximation, but should give reasonable estimates for the averages as well as in cases where the bin size is small. </para></internal>
    </detaileddescription>
  </compounddef>
</doxygen>
