<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.5">
  <compounddef id="page_analysisnbsearch" kind="page">
    <compoundname>page_analysisnbsearch</compoundname>
    <title>Neighborhood search for analysis tools</title>
    <detaileddescription>
<para>The header <ref refid="nbsearch_8h" kindref="compound">nbsearch.h</ref> declares a C++ interface to a relatively flexible and efficient neighborhood search. It is currently implemented within the selection module where it originated, but it does not have any dependencies on the other selection code and can be easily split out in the future.</para><para>The emphasis is on flexibility and ease of use; one main driver is to have one common implementation of grid-based searching to avoid replicating this in multiple tools (and to make more tools take advantage of the significant performance improvement this allows). The main features that it provides:</para><para><itemizedlist>
<listitem><para>Grid-based searching with any triclinic box shape that GROMACS supports (i.e., a triangular box matrix and not too skewed).</para></listitem><listitem><para>Grid-based searching with all PBC options except for screw boundary conditions.</para></listitem><listitem><para>With no PBC, grid-based searching where the grid is constructed based on the bounding box of the gridded atoms.</para></listitem><listitem><para>Efficient, rectangular grid cells whose size is determined by particle density and not limited by the cutoff.</para></listitem><listitem><para>Transparent fallback to a simple all-pairs search if the cutoff is too long for the algorithm or grid searching is not otherwise supported.</para></listitem><listitem><para>Support for either N-vs-M pair search with two sets of coordinates, or for all pairs within a single set of coordinates.</para></listitem><listitem><para>Support for computing all distances in the XY plane only (and still grid-based).</para></listitem><listitem><para>Convenience functions for finding the shortest distance or the nearest pair between two sets of positions.</para></listitem><listitem><para>Basic support for exclusions.</para></listitem><listitem><para>Thread-safe handling of multiple concurrent searches with the same cutoff with the same or different reference positions.</para></listitem></itemizedlist>
</para><para><heading level="1">Usage </heading>
</para><para>The neighborhood search works conceptually with two different sets of coordinates:</para><para><itemizedlist>
<listitem><para><emphasis>reference positions</emphasis>: When initiating the search, you provide one set of reference positions that get placed on the search grid and determine the size of the grid.</para></listitem><listitem><para><emphasis>test positions</emphasis>: For each set of reference positions, you provide a set of test positions (or a single position). The search is performed from each test position, finding the reference positions within the cutoff from this point. It is possible to perform multiple searches against the same set of reference positions (and the same grid).</para></listitem></itemizedlist>
</para><para>To start using the neighborhood search, you need to first create an instance of <ref refid="classgmx_1_1AnalysisNeighborhood" kindref="compound">gmx::AnalysisNeighborhood</ref>. This class allows you to set some global properties for the search (most notably, the cutoff distance). Then you provide the reference positions as a <ref refid="classgmx_1_1AnalysisNeighborhoodPositions" kindref="compound">gmx::AnalysisNeighborhoodPositions</ref> and PBC information to get a <ref refid="classgmx_1_1AnalysisNeighborhoodSearch" kindref="compound">gmx::AnalysisNeighborhoodSearch</ref> instance. You can then either use methods directly in this class to find, e.g., the nearest reference point from a test position, or you can do a full pair search that returns you all the reference-test pairs within a cutoff. The pair search is performed using an instance of <ref refid="classgmx_1_1AnalysisNeighborhoodPairSearch" kindref="compound">gmx::AnalysisNeighborhoodPairSearch</ref> that the search object returns. Methods that return information about pairs return an instance of <ref refid="classgmx_1_1AnalysisNeighborhoodPair" kindref="compound">gmx::AnalysisNeighborhoodPair</ref>, which can be used to access the indices of the reference and test positions in the pair, as well as the computed distance. See the class documentation for these classes for details.</para><para>For use together with selections, an instance of <ref refid="classgmx_1_1Selection" kindref="compound">gmx::Selection</ref> or <ref refid="classgmx_1_1SelectionPosition" kindref="compound">gmx::SelectionPosition</ref> can be transparently passed as the positions for the neighborhood search.</para><para><heading level="1">Implementation </heading>
</para><para>This section provides a high-level overview of the algorithm used. It is not necessary to understand all the details to use the API, but it can be useful to get the best performance out of it. The main audience is developers who may need to extend the API to make it suitable for more cases.</para><para>The grid for the search is initialized based on the reference positions and the PBC information:</para><para><itemizedlist>
<listitem><para>The grid cells are always rectangular, even for fully triclinic boxes.</para></listitem><listitem><para>If there is no PBC, the grid edges are defined from the bounding box of the reference positions; with PBC, the grid covers the unit cell.</para></listitem><listitem><para>The grid cell size is determined such that on average, each cell contains ten particles. Special considerations are in place for cases where the grid will only be one- or two-dimensional because of a flat box.</para></listitem><listitem><para>If the resulting grid has too few cells in some dimensions, the code falls back automatically to an all-pairs search. For correct operation, the grid algorithm needs three cells in each dimension, but the code can fall back to a non-gridded search for each dimension separately.</para></listitem><listitem><para>The initialization also pre-calculates the shifts required across the periodic boundaries for triclinic cells, i.e., the fractional number of cells that the grid origin is shifted when crossing the periodic boundary in Y or Z directions.</para></listitem><listitem><para>Finally, all the reference positions are mapped to the grid cells.</para></listitem></itemizedlist>
</para><para>The average number of particles within a cell is somewhat heuristic in the above logic. This has not been particularly optimized for best performance.</para><para>When doing the search for test positions, each test position is considered independently:</para><para><itemizedlist>
<listitem><para>The coordinates of the test position are mapped to the grid coordinate system. The coordinates here are fractional and may lay outside the grid for non-periodic dimensions.</para></listitem><listitem><para>The bounding box of the cutoff sphere centered at the mapped coordinates is determined, and each grid cell that intersects with this box is used for searching the reference positions. So the searched grid cells may vary depending on the coordinates of the test position, even if the test position is within the same cell.</para></listitem><listitem><para>Possible triclinic shifts in the grid are considered when looping over the cells in the cutoff box if the coordinates wrap around a periodic dimension. This is done by shifting the search range in the other dimensions when the Z or Y dimension loop crosses the boundary. </para></listitem></itemizedlist>
</para>    </detaileddescription>
  </compounddef>
</doxygen>
